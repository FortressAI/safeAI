<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knowledge Graphs - Interactive Demo</title>
  <!-- React and ReactDOM -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for JSX transpiling -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Material-UI CDN -->
  <script src="https://unpkg.com/@mui/material@5.0.0/umd/material-ui.development.js" crossorigin></script>
  <!-- D3.js for visualizations -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- Force-Graph library -->
  <script src="https://unpkg.com/force-graph"></script>
  <!-- Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" />
  <!-- Shared styles -->
  <link rel="stylesheet" href="../css/shared-demo.css" />
  <style>
    .graph-container {
      width: 100%;
      height: 600px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .controls-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 8px;
      z-index: 100;
    }
    
    .controls-panel button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 8px 16px;
      background: var(--primary-color);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .controls-panel button:hover {
      background: var(--primary-dark);
    }
    
    .node-details {
      position: absolute;
      left: 20px;
      bottom: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 8px;
      max-width: 300px;
      display: none;
    }
    
    .relationship-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 8px;
      max-width: 250px;
    }
    
    .relationship-type {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .relationship-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .analytics-panel {
      margin-top: 20px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .metric-card {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .metric-label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 5px;
    }
    
    .search-box {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      color: white;
    }
    
    .search-box::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .instructions-section {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid rgba(76, 175, 80, 0.2);
    }

    .instructions-section h2 {
      color: #4CAF50;
      margin-top: 0;
    }

    .feature-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .feature-card {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 15px;
    }

    .feature-card h4 {
      color: #4CAF50;
      margin: 0 0 10px 0;
    }

    .keyboard-shortcut {
      display: inline-block;
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Fira Code', monospace;
      margin: 0 2px;
    }

    .tip {
      background: rgba(33, 150, 243, 0.1);
      border-left: 4px solid #2196F3;
      padding: 10px 15px;
      margin: 10px 0;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { 
      Box, Typography, Button, Card, CardContent, 
      Tabs, Tab, Grid, Divider, 
      IconButton, Tooltip, LinearProgress,
      TextField, Dialog, DialogTitle, DialogContent, DialogActions,
      List, ListItem, ListItemText, ListItemIcon,
      CircularProgress, Alert, Slider, Icon, Chip
    } = MaterialUI;

    function Instructions() {
      return (
        <div className="instructions-section">
          <h2>Interactive Knowledge Graph Explorer</h2>
          <p>
            Explore and analyze relationships between AI agents, systems, and interfaces in this interactive visualization.
            Use the tools and features below to gain insights into the knowledge graph structure.
          </p>

          <div className="feature-list">
            <div className="feature-card">
              <h4>Navigation</h4>
              <ul>
                <li><span className="keyboard-shortcut">Scroll</span> to zoom in/out</li>
                <li><span className="keyboard-shortcut">Click + Drag</span> to pan</li>
                <li><span className="keyboard-shortcut">Double Click</span> to center view</li>
              </ul>
            </div>

            <div className="feature-card">
              <h4>Node Interaction</h4>
              <ul>
                <li>Click a node to view details</li>
                <li>Hover to highlight connections</li>
                <li>Drag nodes to rearrange</li>
              </ul>
            </div>

            <div className="feature-card">
              <h4>Relationship Types</h4>
              <ul>
                <li>Green: Dependencies</li>
                <li>Blue: Interactions</li>
                <li>Yellow: Monitoring</li>
                <li>Red: Protection</li>
                <li>Purple: Connections</li>
              </ul>
            </div>

            <div className="feature-card">
              <h4>Analysis Tools</h4>
              <ul>
                <li>Search nodes by name</li>
                <li>Filter by relationship type</li>
                <li>View node metrics</li>
                <li>Export graph data</li>
              </ul>
            </div>
          </div>

          <div className="tip">
            <strong>Pro Tip:</strong> Use the controls panel in the top-right corner to adjust physics simulation,
            toggle labels, and reset the view. The relationship panel on the left shows all available connection types.
          </div>
        </div>
      );
    }

    // Custom hook for graph data management
    function useGraphData() {
      const [graphData, setGraphData] = React.useState({
        nodes: [],
        links: []
      });
      const [selectedNode, setSelectedNode] = React.useState(null);
      const [isLoading, setIsLoading] = React.useState(false);
      const [error, setError] = React.useState(null);

      const loadGraphData = React.useCallback(async () => {
        setIsLoading(true);
        setError(null);
        try {
          // Simulate API call
          await new Promise(resolve => setTimeout(resolve, 1000));
          setGraphData({
            nodes: [
              { id: 'ethics', name: 'Ethics Agent', type: 'agent', size: 30 },
              { id: 'security', name: 'Security Agent', type: 'agent', size: 30 },
              { id: 'math', name: 'Math Agent', type: 'agent', size: 30 },
              { id: 'arc', name: 'ARC Agent', type: 'agent', size: 30 },
              { id: 'dashboard', name: 'Dashboard', type: 'interface', size: 20 },
              { id: 'browser', name: 'Agent Browser', type: 'interface', size: 20 },
              { id: 'monitor', name: 'System Monitor', type: 'interface', size: 20 }
            ],
            links: [
              { source: 'ethics', target: 'security', type: 'monitoring', strength: 0.7 },
              { source: 'security', target: 'math', type: 'protection', strength: 0.8 },
              { source: 'math', target: 'arc', type: 'interaction', strength: 0.6 },
              { source: 'ethics', target: 'dashboard', type: 'connection', strength: 0.5 },
              { source: 'security', target: 'browser', type: 'connection', strength: 0.5 },
              { source: 'math', target: 'monitor', type: 'connection', strength: 0.5 }
            ]
          });
        } catch (err) {
          setError('Failed to load graph data');
        } finally {
          setIsLoading(false);
        }
      }, []);

      const updateNodePosition = React.useCallback((nodeId, x, y) => {
        setGraphData(prev => ({
          ...prev,
          nodes: prev.nodes.map(node =>
            node.id === nodeId ? { ...node, x, y } : node
          )
        }));
      }, []);

      const addNode = React.useCallback((node) => {
        setGraphData(prev => ({
          ...prev,
          nodes: [...prev.nodes, node]
        }));
      }, []);

      const addLink = React.useCallback((link) => {
        setGraphData(prev => ({
          ...prev,
          links: [...prev.links, link]
        }));
      }, []);

      return {
        graphData,
        selectedNode,
        setSelectedNode,
        isLoading,
        error,
        loadGraphData,
        updateNodePosition,
        addNode,
        addLink
      };
    }

    // Custom hook for graph visualization settings
    function useGraphSettings() {
      const [settings, setSettings] = React.useState({
        nodeSize: 30,
        linkStrength: 0.5,
        charge: -100,
        distance: 100,
        showLabels: true,
        showArrows: true,
        selectedTypes: ['agent', 'interface']
      });

      const updateSetting = React.useCallback((key, value) => {
        setSettings(prev => ({
          ...prev,
          [key]: value
        }));
      }, []);

      const toggleType = React.useCallback((type) => {
        setSettings(prev => ({
          ...prev,
          selectedTypes: prev.selectedTypes.includes(type)
            ? prev.selectedTypes.filter(t => t !== type)
            : [...prev.selectedTypes, type]
        }));
      }, []);

      return {
        settings,
        updateSetting,
        toggleType
      };
    }

    // Graph Node Component
    const GraphNode = React.memo(function GraphNode({ node, isSelected, onClick }) {
      const nodeColor = node.type === 'agent' ? '#4CAF50' : '#2196F3';
      
      return (
        <g
          transform={`translate(${node.x},${node.y})`}
          onClick={() => onClick(node)}
          style={{ cursor: 'pointer' }}
        >
          <circle
            r={node.size}
            fill={nodeColor}
            stroke={isSelected ? '#fff' : 'none'}
            strokeWidth={isSelected ? 2 : 0}
          />
          {node.name && (
            <text
              x={node.size + 5}
              y={5}
              fill="#fff"
              fontSize="12"
              textAnchor="start"
            >
              {node.name}
            </text>
          )}
        </g>
      );
    });

    // Graph Link Component
    const GraphLink = React.memo(function GraphLink({ link, settings }) {
      const linkColor = {
        monitoring: '#4CAF50',
        protection: '#F44336',
        interaction: '#FFC107',
        connection: '#9C27B0'
      }[link.type] || '#fff';

      return (
        <line
          x1={link.source.x}
          y1={link.source.y}
          x2={link.target.x}
          y2={link.target.y}
          stroke={linkColor}
          strokeWidth={link.strength * 2}
          opacity={0.6}
        />
      );
    });

    // Node Details Dialog Component
    const NodeDetailsDialog = React.memo(function NodeDetailsDialog({
      node,
      open,
      onClose,
      onAddLink
    }) {
      const [targetNode, setTargetNode] = React.useState('');
      const [linkType, setLinkType] = React.useState('connection');
      const [linkStrength, setLinkStrength] = React.useState(0.5);

      const handleAddLink = React.useCallback(() => {
        if (targetNode) {
          onAddLink({
            source: node.id,
            target: targetNode,
            type: linkType,
            strength: linkStrength
          });
          onClose();
        }
      }, [node.id, targetNode, linkType, linkStrength, onAddLink, onClose]);

      return (
        <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
          <DialogTitle>
            <Box sx={{ display: 'flex', alignItems: 'center' }}>
              <Icon sx={{ mr: 1 }}>{node.type === 'agent' ? 'smart_toy' : 'dashboard'}</Icon>
              {node.name}
            </Box>
          </DialogTitle>
          <DialogContent>
            <List>
              <ListItem>
                <ListItemIcon><Icon>category</Icon></ListItemIcon>
                <ListItemText primary="Type" secondary={node.type} />
              </ListItem>
              <ListItem>
                <ListItemIcon><Icon>info</Icon></ListItemIcon>
                <ListItemText primary="ID" secondary={node.id} />
              </ListItem>
            </List>

            <Divider sx={{ my: 2 }} />

            <Typography variant="h6" gutterBottom>
              Add Connection
            </Typography>
            <TextField
              select
              fullWidth
              label="Target Node"
              value={targetNode}
              onChange={(e) => setTargetNode(e.target.value)}
              sx={{ mb: 2 }}
            >
              {graphData.nodes
                .filter(n => n.id !== node.id)
                .map(n => (
                  <MenuItem key={n.id} value={n.id}>
                    {n.name}
                  </MenuItem>
                ))}
            </TextField>

            <TextField
              select
              fullWidth
              label="Connection Type"
              value={linkType}
              onChange={(e) => setLinkType(e.target.value)}
              sx={{ mb: 2 }}
            >
              <MenuItem value="monitoring">Monitoring</MenuItem>
              <MenuItem value="protection">Protection</MenuItem>
              <MenuItem value="interaction">Interaction</MenuItem>
              <MenuItem value="connection">Connection</MenuItem>
            </TextField>

            <Typography gutterBottom>
              Connection Strength
            </Typography>
            <Slider
              value={linkStrength}
              onChange={(_, value) => setLinkStrength(value)}
              min={0}
              max={1}
              step={0.1}
              marks
            />
          </DialogContent>
          <DialogActions>
            <Button onClick={onClose}>Cancel</Button>
            <Button onClick={handleAddLink} variant="contained">
              Add Connection
            </Button>
          </DialogActions>
        </Dialog>
      );
    });

    // Main Knowledge Graph Component
    function KnowledgeGraph() {
      const {
        graphData,
        selectedNode,
        setSelectedNode,
        isLoading,
        error,
        loadGraphData,
        updateNodePosition,
        addNode,
        addLink
      } = useGraphData();

      const {
        settings,
        updateSetting,
        toggleType
      } = useGraphSettings();

      const graphRef = React.useRef(null);

      // Effect for initial data load
      React.useEffect(() => {
        loadGraphData();
      }, [loadGraphData]);

      // Effect for graph visualization
      React.useEffect(() => {
        if (!graphRef.current) return;

        const svg = d3.select(graphRef.current);
        const width = svg.node().getBoundingClientRect().width;
        const height = svg.node().getBoundingClientRect().height;

        // Clear previous content
        svg.selectAll('*').remove();

        // Create simulation
        const simulation = d3.forceSimulation(graphData.nodes)
          .force('link', d3.forceLink(graphData.links)
            .id(d => d.id)
            .distance(settings.distance)
            .strength(settings.linkStrength))
          .force('charge', d3.forceManyBody().strength(settings.charge))
          .force('center', d3.forceCenter(width / 2, height / 2));

        // Create links
        svg.append('g')
          .selectAll('line')
          .data(graphData.links)
          .join('line')
          .attr('stroke', '#999')
          .attr('stroke-opacity', 0.6)
          .attr('stroke-width', d => Math.sqrt(d.strength));

        // Create nodes
        const node = svg.append('g')
          .selectAll('g')
          .data(graphData.nodes)
          .join('g')
          .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));

        node.append('circle')
          .attr('r', d => d.size)
          .attr('fill', d => d.type === 'agent' ? '#4CAF50' : '#2196F3');

        if (settings.showLabels) {
          node.append('text')
            .attr('x', d => d.size + 5)
            .attr('y', 5)
            .text(d => d.name)
            .attr('fill', '#fff')
            .attr('font-size', '12px');
        }

        // Update positions on each tick
        simulation.on('tick', () => {
          svg.selectAll('line')
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

          node.attr('transform', d => `translate(${d.x},${d.y})`);
        });

        // Drag functions
        function dragstarted(event) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          event.subject.fx = event.subject.x;
          event.subject.fy = event.subject.y;
        }

        function dragged(event) {
          event.subject.fx = event.x;
          event.subject.fy = event.y;
        }

        function dragended(event) {
          if (!event.active) simulation.alphaTarget(0);
          event.subject.fx = null;
          event.subject.fy = null;
          updateNodePosition(event.subject.id, event.x, event.y);
        }

        return () => {
          simulation.stop();
        };
      }, [graphData, settings, updateNodePosition]);

      return (
        <Box sx={{ p: 3 }}>
          <Typography variant="h4" gutterBottom>
            Knowledge Graph Explorer
          </Typography>
          <Typography variant="subtitle1" color="text.secondary" paragraph>
            Visualize and analyze relationships between AI agents and systems
          </Typography>

          {error && (
            <Alert severity="error" sx={{ mb: 2 }}>
              {error}
            </Alert>
          )}

          <Grid container spacing={3}>
            <Grid item xs={12} md={8}>
              <Paper className="graph-container">
                {isLoading ? (
                  <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100%' }}>
                    <CircularProgress />
                  </Box>
                ) : (
                  <svg ref={graphRef} width="100%" height="100%" />
                )}
              </Paper>
            </Grid>
            <Grid item xs={12} md={4}>
              <Paper sx={{ p: 2 }}>
                <Typography variant="h6" gutterBottom>
                  Graph Settings
                </Typography>
                <Box sx={{ mb: 2 }}>
                  <Typography gutterBottom>
                    Node Size
                  </Typography>
                  <Slider
                    value={settings.nodeSize}
                    onChange={(_, value) => updateSetting('nodeSize', value)}
                    min={10}
                    max={50}
                    step={5}
                    marks
                  />
                </Box>
                <Box sx={{ mb: 2 }}>
                  <Typography gutterBottom>
                    Link Strength
                  </Typography>
                  <Slider
                    value={settings.linkStrength}
                    onChange={(_, value) => updateSetting('linkStrength', value)}
                    min={0}
                    max={1}
                    step={0.1}
                    marks
                  />
                </Box>
                <Box sx={{ mb: 2 }}>
                  <Typography gutterBottom>
                    Node Types
                  </Typography>
                  <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                    {['agent', 'interface'].map(type => (
                      <Chip
                        key={type}
                        label={type}
                        onClick={() => toggleType(type)}
                        color={settings.selectedTypes.includes(type) ? 'primary' : 'default'}
                      />
                    ))}
                  </Box>
                </Box>
              </Paper>
            </Grid>
          </Grid>

          {selectedNode && (
            <NodeDetailsDialog
              node={selectedNode}
              open={!!selectedNode}
              onClose={() => setSelectedNode(null)}
              onAddLink={addLink}
            />
          )}
        </Box>
      );
    }

    ReactDOM.render(<KnowledgeGraph />, document.getElementById('root'));
  </script>
</body>
</html> 